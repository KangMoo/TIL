## 병렬 처리에서 데이터 공유

클로저에서 쓰레드간에 하나의 값을 바꾼다면 어떻게 해야 할까? 클로저에서 값을 변경하는 방법에 대해 다루지 않았기 때문에 각 스레드는 변경된 값을 새로 바인딩하는 방법으로 데이터를 공유할 수 있을 것이다.

루트 바인딩을 바꾸는 함수는 `alter-root-var`이다. 이 함수를 이용해서 여러 쓰레드가 `counter`를 증가시키는 예제를 만들어 보자

```clojure
(def counter 0)

(defn new-thread []
  (Thread.
    (fn []
      (alter-var-root (var counter) inc))))

(defn run []
  (dotimes [_ 100]
    (.start (new-thread))))

(run)

;; => counter
;; 100
```

`dotimes` 는 반복 횟수와 인덱스를 받아 구문을 실행해주는 매크로다. 절차형 언어의 반복문과 비슷하다. `_`를 사용한 이유는 인덱스를 따로 바인딩하지 않겠다는 뜻이다

예제는 예상대로 잘 동작하고 카운트도 동기화 문제없이 100이 나왔다. `alter-root-var`가 동기화에 문제가 생기지 않는 이유는 `alter-root-var`가 동기화 함수이기 때문이다

클로저에는 스레드간 데이터 공유를 위해 새로운 값을 다시 바인딩하는 방법 말고 실제 값을 바꿀 수 있는 몇가지 기능을 제공한다

가장 많이 사용하는 atom과 트랜젝션을 제공하는 ref와 agent가 있다